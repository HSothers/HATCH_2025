---
# title: "HATCH_2025"
# author: "Genome Guild"
# date: "2025-03-01"
output: html_document
runtime: shiny
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)





library(tidyverse) 
library(reticulate) #r and python integration
library(shiny)
library(bslib)
library(digest)
library(Rook)
library(shinythemes)
library(htmlwidgets)
```


```{python}
 #example python chunk 
 
```

```{r functions}

#takes in the username from the login page, and determines what the access level is based on the role
Access_Bool<-function(username,access_level){
  
access_level<-  case_when(
    access_level == 0 ~ "Laboratory_Personnel",
    access_level == 1 ~ "Secondary_Clinician",
    access_level == 2 ~ "Primary_Clinician",
    .default = NA
  )
  
  Access_Bool<-users$role[which(users$username==user_out)]
  Access_Bool<-ifelse(tolower(access_level)==tolower(Access_Bool),1,0)
  return(Access_Bool)
}

```




# {.tabset}

## Home  
```{r}

```


```{r UsernameDummyCode}
#user database with hashed passwords
users <- data.frame(
  username = c("admin", "user1","DrPepper"),
  password = c(digest("password123", algo = "sha256"), digest("mypassword", algo = "sha256"),digest("mypassword", algo = "sha256")),
  email = c("admin@example.com", "user1@example.com","Fizzy@Sodapop.edu"),  # Emails for sending OTP
  role = c("Primary_Clinician","Laboratory_Personnel","Secondary_Clinician"),
  stringsAsFactors = FALSE
)

# Store OTPs (in a real app, use a database or session-based storage)
otp_storage <- reactiveValues(otp = NULL, user = NULL, otp_requested = FALSE)  # Added otp_requested

```


```{r}
ui <- page_navbar(
  title = "Worm Hole",
  sidebar = color_by,
  nav_spacer(),
  nav_panel("Home", cards[[1]]),
  nav_panel("About Us", cards[[2]]),
  nav_panel("Lab", cards[[3]]),
  nav_panel("Clinical",cards[[4]]),
  nav_item(tags$a("Posit", href = "https://posit.co"))
)

shinyApp(ui, server)
```



```{r loginW2fa}

shiny
# Define UI
ui <- fluidPage(
  theme = shinytheme("cerulean"),
  titlePanel("WormHole Login Page"),
  sidebarLayout(
    sidebarPanel(
      textInput("username", "Username:", placeholder = "Enter your username"),
      passwordInput("password", "Password:", placeholder = "Enter your password"),
      actionButton("login", "Login", class = "btn-primary"),
      uiOutput("otp_ui")  # OTP Input UI (only shown after login step)
    ),
    mainPanel(
      br(),  # Adds some spacing
      textOutput("message")
    )
  )
)
# Define server logic
server <- function(input, output, session) {
  observeEvent(input$login, {
    user <- input$username
    pass <- digest(input$password, algo = "sha256")  # Hash the entered password
    # Reset OTP UI when a new login attempt is made
    otp_storage$otp_requested <- FALSE
    output$otp_ui <- renderUI(NULL)  # Clear previous OTP UI
    # Check if username exists in the database
    if (user %in% users$username) {
      stored_pass <- users$password[users$username == user]
      if (pass == stored_pass) {
        # Generate a random 6-digit OTP
        otp_storage$otp <- sprintf("%06d", sample(100000:999999, 1))
        otp_storage$user <- user
        # Simulate sending OTP (for real apps, use an email API)
        email <- users$email[users$username == user]
        cat("Sending OTP to", email, ":", otp_storage$otp, "\n")
        # Ensure OTP UI is displayed only once per login
        otp_storage$otp_requested <- TRUE
        output$message <- renderText("OTP has been sent to your email. Please enter it below.")
        # Show OTP input field dynamically
        output$otp_ui <- renderUI({
          tagList(
            textInput("otp", "Enter OTP:", placeholder = "Enter the OTP sent to your email"),
            actionButton("verify_otp", "Verify OTP", class = "btn-success")
          )
        })
      } else {
        output$message <- renderText("Invalid username or password.")
      }
    } else {
      output$message <- renderText("Invalid username or password.")
    }
  })
  observeEvent(input$verify_otp, {
    if (!is.null(otp_storage$otp) && input$otp == otp_storage$otp) {
      output$message <- renderText("Welcome to Wormhole! Login successful.")
      otp_storage$otp <- NULL  # Reset OTP after successful login
      otp_storage$otp_requested <- FALSE  # Reset so OTP UI disappears
      user_out<<-input$username
      # Clear OTP UI after successful login
      output$otp_ui <- renderUI(NULL)
    } else {
      output$message <- renderText("Invalid OTP. Please try again.")
      
      
 }
  })

}
# Run the application
shinyApp(ui = ui, server = server)

```


![Worms](CrawlingCelegans.gif)

## About Us 

## Laboratory  

```{r LabAccessCheck}

# ifelse(Access_Bool(user_out,access_level=0)==0,"Page not available - incorrect permissions.")
# 
# # Lab_bool


```


## Clinician  

